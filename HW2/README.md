## ДЗ 2: видео-фильтр с использованием библиотеки OpenCV

### Chroma key

Хромакей — технология совмещения двух кадров в одной композиции. С помощью хромакея можно поместить людей или предметы на произвольный фон, снятый в другом месте. 

Программа получает на вход видеоряд. В процессе его проигрывания пользователь должен кликнуть по цвету, который хочет использовать в качестве хромакея. Во всех следующих кадрах он будет заменен на какое-то заранее выбранное изображение. Нажав на Z, можно отменить изменение и выбрать цвет заново.

#### Описание алгоритма замены цвета:

В стандартной RGВ модели неудобно определять диапазон близких оттенков. Поэтому преобразуем текущий кадр из RGB в HSV с помощью функции `frame_hsv = cv2.cvtColor(frame, cv2.COLOR_BGR2HSV)`.

**HSV** (англ. Hue, Saturation, Value — тон, насыщенность, значение) — цветовая модель, нелинейное преобразование модели RGB. Визуально её можно представить так:

![](hsv.png)

Ось x (Hue) представляет оттенок в диапазоне [0, 180], ось y (Saturation) - в диапазоне [0, 255], значения Value аналогичны Saturation.

Получим цвет в выбранной точке - `[h, s, v]`. Определим диапазон, который подходит для удаления. После изучения цветовой карты логично положить значения H такими: `[h - 20, h + 20]`. Диапазоны значений SV: [0, 50] - для светлых оттенков, [50, 255] - для более ярких и тёмных. Так мы учтём все тени и шумы на изображении.

Создадим бинарную маску, где каждая единица определяет точку изображения, чей цвет лежит в выбранном диапазоне, а каждый ноль - точку, чей цвет лежит вне диапазона: `mask = cv2.inRange(frame_hsv, lower_color, upper_color)`.

С помощью маски удалим цвет с текущего кадра: `masked_frame[mask != 0] = [0, 0, 0]`.

На изображении, выбранном в качестве замены цвета, удалим область, где точки маски равны 0: `background[mask == 0] = [0, 0, 0]`.

Итоговое изображение получается как сумма двух: `frame = background + masked_frame`.

Чтобы сделать переход между фоном и передним планом более естественным, добавим блюр. Выделим контуры на бинарной маске и нарисуем их на пустом изображении:

`contours, _ = cv2.findContours(mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)`

`cv2.drawContours(contours_img, contours, -1, (255, 255, 255), 3)`

Найдём полностью размытое изображение и наложим его на итоговое изображение в точках контура:

`blurred_img = cv2.GaussianBlur(frame, (21, 21), 0)`

`frame = np.where(contours_img == np.array([255, 255, 255]), blurred_img, frame)`

#### Управление:

- ЛКМ: для выбора цвета, который использовать в качестве хромакея.
- Z: отменить последнее применение хромакея.
- Esc: для выхода из окна проигрывания видео.

#### Примеры использования:

![](examples/chromakey_1.gif)

![](examples/chromakey_2.gif)